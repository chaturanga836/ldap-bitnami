version: '3.8'

services:
  ldap:
    build: .
    container_name: ldap-custom-prod
    user: root  # Needed for the initial chown/chmod in your script
    env_file: .env
    ports:
      - "389:389"
      - "636:636" 
    volumes:
      - ldap_db:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      # Mount your Windows-generated certs
      - ./certs/ldap.crt:${LDAP_TLS_CERT}
      - ./certs/ldap.key:${LDAP_TLS_KEY}
      - ./certs/ca.crt:${LDAP_TLS_CA_CRT}
    
    # We REMOVE the command block entirely.
    # The Dockerfile already says ENTRYPOINT ["/entrypoint.sh"]
    
    healthcheck:
      test: ["CMD", "ldapsearch", "-H", "ldap://localhost", "-b", "cn=config", "-1"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  ldap_db:
  ldap_config: